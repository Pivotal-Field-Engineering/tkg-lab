# Install TKG Management Cluster

Follow the [official docs](https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/index.html) for background and pre-requisite tasks.

First complete `Set Up the Bootstrap Environment for Tanzu Kubernetes Grid` which gets your tkg cli, kubectl and docker setup.

Then Follow the next section that applies for your environment: AWS or vSphere. These instructions are based on the official docs steps that use the CLI. Alternatively you can use the Installer Interface and have the config file autogenerated with correct & well formatted values.

**Note**
The script uses AWS cli and the key is created using the current region. For smooth execution
it is important to set the AWS default config to the same region as the region you specify in params and config yaml.
Run
```bash
aws configure
```
to select the default region. 

## Install TKG Management Cluster on AWS

1. Complete `Prepare to Deploy the Management Cluster to Amazon EC2` which does setup activity in EC2. You can use the following script and stores the private key in the `keys` directory.

```bash
./scripts/01-prep-aws-objects.sh
```

2. Complete `Deploy the Management Cluster to Amazon EC2 with the CLI`. You can use the `REDACTED-config.yaml` locate at the root of this repo as a reference of what a given config.yaml ended up looking like after the tasks described in the docs.  Also, you can use this script to complete the deployment.

```bash
./scripts/02-deploy-aws-mgmt-cluster.sh
```

3. At this point the management cluster is deployed.  We will be adding a few additional components such that we would benefit from two worker nodes in the cluster.  Also, in order to be nice to our users, let's deploy a default storage class.  The following script will perform these actions.

```bash
./scripts/03-post-deploy-mgmt-cluster.sh
```

4. Validation Step. Check management cluster is provisioned, pods are running and sc is configured;

```bash
tkg get management-clusters
kubectl get pods -A
kubectl get sc
```

## Install TKG Management Cluster on vSphere

1. Complete `Prepare to Deploy the Management Cluster to vSphere` which prepares an SSH key and the OS image templates to be used for all clusters.

First thing you need to do is to download the OVAs from https://www.vmware.com/go/get-tkg. You need to get:
- VMware Tanzu Kubernetes Grid 1.1.0 Kubernetes v1.18.3 OVA (Photon OS)
- VMware Tanzu Kubernetes Grid 1.1 Load Balancer OVA

Then you can follow the manual steps in the documentation or use the following script to automate the creation of the SSH key, upload OVAs and set as template. SSH keys will be stored at `keys/tkg_rsa` and `keys/tkg_rsa.pub`.

You'll need to install [govc](https://github.com/vmware/govmomi/tree/master/govc#installation). You'll also need to fill the `vsphere` configuration block of the `params.yaml` file with the values from your vSphere environment and local folders. Then run this script:

```bash
./scripts/01-prep-vsphere-objects.sh
```

2. Complete `Deploy the Management Cluster to vSphere with the CLI`.
You can use the `REDACTED-config.yaml` locate at the root of this repo as a reference of what a given config.yaml ended up looking like after the tasks described in the docs. If you run the script in the previous step you'll see the `~/.tkg/config.yaml` has been already pre-populated with some variables. Make sure to add the rest as per the docs and/or the the `REDACTED-config.yaml` for vSphere. Also, you can use this script to complete the deployment.

```bash
./scripts/02-deploy-vsphere-mgmt-cluster.sh
```

3. At this point the management cluster is deployed.  We will be adding a few additional components such that we would benefit from two worker nodes in the cluster.  Also, in order to be nice to our users, let's configure a CSI Storage Policy deploy a default storage class.

Follow these steps in vCenter:
- Tags & Custom Attributes -> Categories -> New -> k8s-storage (Datastore, Datastore Cluster)
- Tags & Custom Attributes -> Tags -> New -> k8s-storage (choose k8s-storage category)
- Storage -> Select datastore -> Tags -> Assign Tag (k8s-storage)
- Policies & Profiles > VM Storage Profiles > Create VM Storage Policy
  - Name: “k8s Storage Policy”
  - Enable tag placement
  - Choose category and tag created previously
  - Confirm your storage Datastore is compatible

Then run the following command to scale to 2 worker nodes and apply a default storage class that uses the CNS provisioner to the cluster.

```bash
./scripts/03-post-deploy-mgmt-cluster.sh
```

4. Validation Step. Check management cluster is provisioned, pods are running and the sc is configured;

```bash
tkg get management-clusters
kubectl get pods -A
kubectl get sc
```

## Go to Next Step

[Attach Management Cluster to TMC](02_attach_tmc_mgmt.md)
